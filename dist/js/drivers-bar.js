function updateGraphs(){function t(a){var n=getURL("https://www.track.kabzy.com/api/jobs/"+a);n.success(function(n){var r=n;if("done"==r.state){var o=getURL("https://www.track.kabzy.com/api/jobs/"+a+"/data.json");o.success(function(t){$.each(t,function(t,e){l[e.vid]={dev_dist:e.dev_dist,dev_ospeed:e.dev_ospeed,dev_idle:e.dev_idle,dev_ign:e.dev_ign}});var a=getURL(i);a.success(function(t){e(t.job_id)})})}else t(a)})}function e(t){var a=getURL("https://www.track.kabzy.com/api/jobs/"+t);a.success(function(a){var n=a;if("done"==n.state){var r=getURL("https://www.track.kabzy.com/api/jobs/"+t+"/data.json");r.success(function(t){$.each(t,function(t,e){40==e.code?l[e.vid].harshA=e.count:39==e.code?l[e.vid].harshB=e.count:47==e.code?l[e.vid].aggLane=e.count:48==e.code&&(l[e.vid].harshC=e.count)}),scores(l)})}else e(t)})}$("#loadSpinner").show();var a=$("#datePicker").data("daterangepicker"),n=a.startDate.format("YYYY-MM-DD"),r=a.endDate.format("YYYY-MM-DD"),o=$(".selectpicker").val(),s="https://www.track.kabzy.com/api/counters?vehicles="+o+"&from="+n+"&to="+r+"&distance=meter&time=hour&async=1&delta=7D",i="https://www.track.kabzy.com/api/rawdata?vehicles="+o+"&fields=$basic,ac,count:1&from="+n+"T00:00:00&to="+r+"T23:59:59&codes=48,47,40,39&resample=event_time&group_by=vid,code&how=count:sum&freq=31D&async=1",c=getURL(s);c.success(function(e){t(e.job_id)});var l={}}function scores(t){var e=[],a=[],n=[],r=[];$.each(t,function(t,o){var s,i=o.dev_dist,c=(Math.ceil(Math.floor(o.dev_dist)/1e3),o.dev_ign/60),l=o.dev_idle/60,d=o.dev_ospeed/60,u=Math.floor(d/c*100),m=Math.floor(l/c*100);s=null!=o.harshA?o.harshA:0;var h;h=null!=o.harshB?o.harshB:0;var p=1*s+1*h&&1*i!==0?2e6*(1*s+1*h)/i:0,f=isNaN(3*u)?0:3*u,v=isNaN((p+f)/2)?0:(p+f)/2,g=100-v<40?40:100-v;g=Math.round(g);var y=isNaN((p+1*u+m)/2)?0:(p+1*u+m)/2,b=100-y<40?40:100-y;b=Math.round(b),e.push(allVehicles[t]),a.push(g),n.push(b),r.push({id:t,label:allVehicles[t],Safety:g,Eco:b})}),d3_bar(r),$("#loadSpinner").hide()}function d3_bar(t){d3.select(".chart").remove(),margin={top:10,right:50,bottom:20,left:200},width=parseInt(d3.select(".chart-panel").style("width"),10)-margin.left-margin.right,h=800,y0=d3.scale.ordinal().rangeRoundBands([h,0],.2,.5),y1=d3.scale.ordinal(),x=d3.scale.linear().range([0,width-margin.right-40]),colorRange=d3.scale.category20(),color=d3.scale.ordinal().range(colorRange.range()),xAxis=d3.svg.axis().scale(x).tickSize(-h).orient("bottom"),yAxis=d3.svg.axis().scale(y0).orient("left"),svg=d3.select(".chart-panel").append("svg").attr("class","chart").attr("width",width+margin.left+margin.right).attr("height",h+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),dataset=t;var e=d3.keys(dataset[0]).filter(function(t){return"label"!==t&&"id"!=t});dataset.forEach(function(t){t.valores=e.map(function(e){return{name:e,value:+t[e]}})}),y0.domain(dataset.map(function(t){return t.label})),y1.domain(e).rangeRoundBands([0,y0.rangeBand()]),x.domain([0,d3.max(dataset,function(t){return d3.max(t.valores,function(t){return t.value})})]),svg.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(xAxis),svg.append("g").attr("class","y axis").call(yAxis);var a=svg.selectAll(".bar").data(dataset).enter().append("g").attr("class","rect").attr("transform",function(t){return"translate( 0,"+y0(t.label)+")"}),n=a.selectAll("rect").data(function(t){return t.valores}).enter();n.append("rect").attr("height",y1.rangeBand()).attr("y",function(t){return y1(t.name)}).attr("x",function(t){return 0}).attr("value",function(t){return t.name}).attr("width",function(t){return x(t.value)}).style("fill",function(t){return"Safety"===t.name?barColors[0]:barColors[1]}),n.append("text").attr("x",function(t){return x(t.value)+5}).attr("y",function(t){return y1(t.name)+y1.rangeBand()/2}).attr("dy",".35em").text(function(t){return t.value}),a.on("mousemove",function(t){divTooltip.style("left",d3.event.layerX+20+"px"),divTooltip.style("top",d3.event.layerY+20+"px"),divTooltip.style("display","inline-block");var e=(d3.event.pageX,d3.event.pageY,document.querySelectorAll(":hover"));l=e.length,l-=1,elementData=e[l].__data__,divTooltip.html(t.label+"<br>"+elementData.name+"<br>"+elementData.value+"%")}),a.on("mouseout",function(t){divTooltip.style("display","none")}),a.on("click",function(t){var e=$("#datePicker").data("daterangepicker"),a=e.startDate.format("YYYY-MM-DD"),n=e.endDate.format("YYYY-MM-DD");window.open("drivers.html?id="+t.id+"&from="+a+"&to="+n)});var r=svg.selectAll(".legend").data(e.slice()).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+20*e+")"});r.append("rect").attr("x",parseInt(d3.select(".chart-panel").style("width"),10)-margin.left-margin.right).attr("width",30).attr("height",30).style("fill",function(t,e){return barColors[e%2]}),r.append("text").attr("x",parseInt(d3.select(".chart-panel").style("width"),10)-margin.left-margin.right-10).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(t){return t})}function d3_change(t){if(dataset){var e;switch(t){case"name":e=y0.domain(dataset.sort(function(t,e){return d3.ascending(e.label,t.label)}).map(function(t){return t.label})).copy();break;case"safety":e=y0.domain(dataset.sort(function(t,e){return t.Safety-e.Safety}).map(function(t){return t.label})).copy();break;case"eco":e=y0.domain(dataset.sort(function(t,e){return t.Eco-e.Eco}).map(function(t){return t.label})).copy()}svg.selectAll(".bar").sort(function(t,a){return e(t.label)-e(a.label)});var a=svg.transition().duration(750),n=function(t,e){return 50*e};a.selectAll(".rect").delay(n).attr("transform",function(t){return"translate( 0,"+e(t.label)+")"}),a.select(".y.axis").call(yAxis).selectAll("g").delay(n)}}var graph;$(document).ready(function(){$("#loadSpinner").hide()}),$(function(){$('input[name="daterange"]').daterangepicker({locale:{format:"DD-MM-YYYY"},startDate:moment().subtract(7,"days"),endDate:moment(),ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},alwaysShowCalendars:!0})}),$('input[name="daterange"]').on("apply.daterangepicker",function(t,e){});var vehicleSet=getURL("https://www.track.kabzy.com/api/vehicles"),allVehicles={};vehicleSet.success(function(t){var e=t;e=e.data;e.map(function(t){return t.id});$.each(e,function(t,e){$("#vehicleSelect").append("<option value="+e.id+">"+e.id+" - "+e.name+"</option>"),allVehicles[e.id]=e.name}),$("#vehicleSelect").selectpicker("refresh")}),$(".dropdown-menu li a").on("click",function(){d3_change($(this).attr("id"))});var barColors=["#ff8800","#02d914"],dataset=null,margin,y0,y1,x,colorRange=d3.scale.category20(),color=d3.scale.ordinal().range(colorRange.range()),xAxis,yAxis,divTooltip=d3.select(".chart-panel").append("div").attr("class","toolTip"),svg;