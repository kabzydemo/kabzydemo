function getQueryVariable(e){for(var t=window.location.search.substring(1),a=t.split("&"),s=0;s<a.length;s++){var n=a[s].split("=");if(n[0]==e)return n[1]}return null}function updateGraphs(){$("#loadSpinner").show();var e=$("#datePicker").data("daterangepicker"),t=e.startDate.format("YYYY-MM-DD"),a=e.endDate.format("YYYY-MM-DD"),s=document.getElementById("vehicleSelect").value;if(null!=s){var n="https://www.track.kabzy.com/api/counters?vehicles="+s+"&from="+t+"&to="+a+"&distance=meter&time=hour&delta=7D",r=getURL(n);r.success(function(e){var n=e.counters;if(e.counters.length>0){distRaw=n[0].dev_dist,dist=Math.ceil(Math.floor(n[0].dev_dist)/1e3),dev_ign=n[0].dev_ign/60,dev_idle=n[0].dev_idle/60;var r=n[0].dev_ospeed/60}else distRaw=0,dist=0,dev_ign=0,dev_idle=0,r=0;speedingPer=Math.floor(r/dev_ign*100),isNaN(speedingPer)?(speedingDonutChart.segments[0].value=0,speedingDonutChart.segments[1].value=100):(speedingDonutChart.segments[0].value=speedingPer,speedingDonutChart.segments[1].value=100-speedingPer),speedingDonutChart.update(),idlePer=Math.floor(dev_idle/dev_ign*100),isNaN(idlePer)?(idleDonutChart.segments[0].value=0,idleDonutChart.segments[1].value=100):(idleDonutChart.segments[0].value=idlePer,idleDonutChart.segments[1].value=100-idlePer),idleDonutChart.update(),getVehicleCodeData(s,t,a),$("#distance").text(dist+" km")})}}function getVehicleCodeData(e,t,a){var s="https://www.track.kabzy.com/api/rawdata?vehicles="+e+"&fields=$basic,ac,count:1&from="+t+"T00:00:00&to="+a+"T23:59:59&codes=48,47,40,39&resample=event_time&group_by=vid,code&how=count:sum&freq=31D",n=getURL(s);n.success(function(e){harshA=0,harshB=0,harshC=0,aggLane=0,$.each(e.events,function(e,t){40==t.code?harshA+=t.count:39==t.code&&(harshB+=t.count)}),isNaN(1*harshA)||0===harshA?harshADonutChart.segments[0].value=.1:harshADonutChart.segments[0].value=harshA,harshADonutChart.update(),isNaN(harshB)||0===harshB?harshBDonutChart.segments[0].value=.1:harshBDonutChart.segments[0].value=harshB,harshBDonutChart.update(),isNaN(harshC)||0===harshC?harshCDonutChart.segments[0].value=.1:harshCDonutChart.segments[0].value=harshC,harshCDonutChart.update(),isNaN(aggLane)||0===aggLane?aggLaneDonutChart.segments[0].value=.1:aggLaneDonutChart.segments[0].value=aggLane,aggLaneDonutChart.update(),scores()})}function scores(){var e=1*harshA+1*harshB&&1*distRaw!==0?2e6*(1*harshA+1*harshB)/distRaw:0,t=isNaN(3*speedingPer)?0:3*speedingPer,a=isNaN((e+t)/2)?0:(e+t)/2,s=100-a<40?40:100-a;s=Math.round(s);var n=isNaN((e+1*speedingPer+idlePer)/2)?0:(e+1*speedingPer+idlePer)/2,r=100-n<40?40:100-n;r=Math.round(r),isNaN(r)?(ecoDonutChart.segments[0].value=0,ecoDonutChart.segments[1].value=100):(ecoDonutChart.segments[0].value=r,ecoDonutChart.segments[1].value=100-r),ecoDonutChart.update(),isNaN(s)?(safetyDonutChart.segments[0].value=0,safetyDonutChart.segments[1].value=100):(safetyDonutChart.segments[0].value=s,safetyDonutChart.segments[1].value=100-s),safetyDonutChart.update(),$("#loadSpinner").hide()}$(function(){$('input[name="daterange"]').daterangepicker({locale:{format:"DD-MM-YYYY"},startDate:moment().subtract(7,"days"),endDate:moment(),ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},alwaysShowCalendars:!0})}),$('input[name="daterange"]').on("apply.daterangepicker",function(e,t){});var vehicleSet=getURL("https://www.track.kabzy.com/api/vehicles"),vehiclesArr=[];vehicleSet.success(function(e){var t=e;t=t.data,$.each(t,function(e,t){$("#vehicleSelect").append("<option value="+t.id+">"+t.id+" - "+t.name+"</option>"),vehiclesArr.push(t.id)});var a=getQueryVariable("id"),s=getQueryVariable("to"),n=getQueryVariable("from");if(a&&s&&n){console.log(a),console.log(n),console.log(s);var r=$("#datePicker").data("daterangepicker");r.setStartDate(moment(n)),r.setEndDate(moment(s)),document.getElementById("vehicleSelect").value=a+"",updateGraphs()}}),$("#loadSpinner").hide();var dist=0,distRaw=0,dev_ign=0,dev_idle=0,speeding=0,harshA=0,harshB=0,harshC=0,aggLane=0,speedingPer=0,idlePer=0;